\ProvidesPackage{beamerthemeR3S}[2026/2/28] % 声明包名和版本日期

\RequirePackage{graphicx} % 插入图片
\RequirePackage{mwe}        % 测试图片
\RequirePackage{amsmath, amssymb}
\RequirePackage{amsfonts}   % 数学字体
\RequirePackage{mathrsfs} % 花体字母
\RequirePackage{eucal}     % 欧拉花体字母
% --- 加载基础宏包 ---
\RequirePackage{etoolbox}      % 加载工具包，用于条件判断和补丁命令
\RequirePackage{tikz}          % 加载 TikZ 绘图包，用于绘制复杂图形和背景

% --- 页面尺寸设置 ---
\RequirePackage{geometry}      % 加载页面几何设置包
\geometry{paperwidth=16cm,paperheight=9cm} % 强制设置纸张大小为 16:9 宽屏 (16cm x 9cm)

% --- 字体设置 ---
% Caladea 是 Cambria 的开源替代品，Carlito 是 Calibri 的开源替代品
\RequirePackage{caladea,carlito} % 加载这两个字体包以获得更好的衬线和无衬线字体
\renewcommand{\familydefault}{\sfdefault} % 将默认字体族重定义为无衬线字体 (Sans Serif)



% --- 加载图片和颜色包 ---
\RequirePackage{graphicx,R3Scolor} % 加载图片处理包和自定义颜色定义包 (sintefcolor.sty)

% --- 移除导航符号 ---
\setbeamertemplate{navigation symbols}{} % 清空导航符号模板，移除右下角的翻页小图标


% --- 定义页脚内容变量 ---
\newcommand{\@footlineauthor}{\insertauthor \enspace$\vert$\enspace} % 定义命令：插入作者名，后跟一个空格和竖线分隔符
\newcommand{\@footlinepayoff}{\@footlineauthor\inserttitle} % 定义命令：页脚主要内容 = 作者 + 竖线 + 标题
\newcommand{\footlinepayoff}[1]{\renewcommand{\@footlinepayoff}{#1}} % 定义用户命令：允许用户自定义页脚的主要内容部分


% --- 定义页脚模板 ---
\setbeamertemplate{footline}{% % 设置页脚的整体模板
  \begin{beamercolorbox}[wd=\textwidth,ht=3mm,dp=1.5mm,rightskip=1cm,leftskip=1cm]{footline} % 创建一个占据全文宽度的颜色盒，高5mm，深3mm，左右留白1cm
  \ifstrempty{\@footlinepayoff}{}{% % 如果页脚内容变量为空，则什么都不做；否则执行以下代码
    % \usebeamerfont{footline}\hfill\@footlinepayoff % 使用页脚字体，右对齐 (\hfill) 插入页脚内容变量
    \usebeamerfont{footline}\@footlinepayoff
   }
   \hfill\insertframenumber/\inserttotalframenumber % 插入当前页码/总页码
  \end{beamercolorbox} % 结束颜色盒
}

% --- 设置页脚颜色并联动块环境颜色 ---
\newcommand{\footlinecolor}[1]{% % 定义命令：设置页脚颜色 (参数 #1 为颜色值)
  \ifstrempty{#1}{% % 如果参数 #1 为空 (即想要透明页脚)
    \footlinepayoff{} % 清空页脚内容
    \setbeamercolor{footline}{fg=darkgray, bg=} % 设置页脚颜色：前景深灰，背景透明
    \setbeamercolor{block title}{fg=white,bg=dred} % 设置块标题颜色：白字，主色背景
    \setbeamercolor{block body}{fg=white,bg=dred} % 设置块正文颜色：白字，主色背景 (注意：原代码此处可能意在让块与页脚同色，若页脚透明则逻辑稍显特殊)
  }{% % 如果参数 #1 不为空 (指定了背景色)
    \footlinepayoff{\@footlineauthor\inserttitle} % 恢复页脚内容为 "作者 | 标题"
    \setbeamercolor{footline}{fg=white,bg=#1} % 设置页脚颜色：白字，#1 指定的背景色
    \setbeamercolor{block title}{fg=white,bg=#1} % 设置块标题颜色：白字，#1 指定的背景色
    \setbeamercolor{block body}{fg=white,bg=#1} % 设置块正文颜色：白字，#1 指定的背景色
  }%
}
% \footlinecolor{} % 默认调用：设置为无页脚背景 (透明)



% --- 定义 Logo 图像 ---
\pgfdeclareimage[width=0.05\paperwidth]{logos}{assets/main_logo.png} % 声明名为 'logo' 的图片，宽度为纸宽的 9%，路径为反色 Logo
\newcommand{\@logo}{logos}



% --- 设置特定元素的颜色 ---
\setbeamercolor{title}{fg=red,bg=white} % 设置标题颜色：主色字，白色背景
\setbeamercolor{alerted text}{fg=red} % 设置强调文本颜色为主色
\setbeamercolor{author}{fg=black} % 设置作者名颜色为黑色
\setbeamercolor{date}{fg=black} % 设置日期颜色为黑色

% --- 设置字体大小和样式 ---
\setbeamerfont{author}{size=\small} % 设置作者名字体为小号
\setbeamerfont{date}{size=\small} % 设置日期字体为小号

\setbeamerfont{title}{series=\bfseries,size=\large} % 设置标题字体为粗体
\setbeamerfont{subtitle}{series=\mdseries,size=\small} % 设置副标题字体为中粗体，小号

\setbeamerfont{frametitle}{series=\bfseries,size=\normalsize} % 设置帧标题字体为粗体
\setbeamerfont{framesubtitle}{series=\mdseries,size=\scriptsize} % 设置帧副标题字体为中粗体
\setbeamerfont{footline}{size=\scriptsize} % 设置页脚字体为极小号

% \setbeamercolor{block title}{series=\bfseries} %\centering 设置块标题字体为居中且粗体 (注意：这里混用了 color 和 font 设置，实际生效取决于 Beamer 版本，通常 series 应在 font 中设)
% 修正建议：上面一行应为 \setbeamerfont{block title}{series=\bfseries} 并在 template 中处理居中，或者保持原样看效果


% --- 定义自定义颜色块环境 ---
\newenvironment{colorblock}[3][white]{% % 定义新环境 colorblock，3个参数，第1个可选默认为白色
	\begingroup % 开始局部组
	\setbeamercolor{block title}{fg=#1,bg=#2} % 在当前组内设置块标题颜色：前景#1，背景#2
	\setbeamercolor{block body} {fg=#1,bg=#2} % 在当前组内设置块正文颜色：前景#1，背景#2
	\begin{block}{#3} % 开始标准 block 环境，标题为 #3
	}{%
	\end{block} % 结束 block 环境
	\endgroup % 结束局部组，恢复之前的颜色设置
}



% --- 设置页眉 (Headline) ---
% 在每张幻灯片的左上角区域放置 Logo
\setbeamertemplate{headline}{\vspace{0.01\textwidth}\hspace{0.01\textwidth}\pgfuseimage{\@logo}} % 设置页眉模板：左侧留白 6% 文本宽度，然后插入当前选定的 Logo






% --- 定义标题页模板 --- 封面页
\setbeamertemplate{title page}{% % 设置标题页模板
%   \footlinecolor{} % 没有作用
  \vskip0pt plus 1filll% % 垂直跳过 0pt，但具有无限伸展性，将内容推到底部 (或者配合下面的 vspacce 调整)
  % 以一种不优雅但有效的方式重新定位盒子 - 向左移 12mm
  \hspace{-12mm} 
  \vspace{20mm} % 向下移动 20mm
  \begin{beamercolorbox}[wd=0.72\textwidth,sep=10pt,leftskip=8mm]{title}% % 创建标题颜色盒：宽 72% 文本宽，内边距 10pt，左缩进 8mm
    {\usebeamerfont{title}\inserttitle} % 插入主标题
  
    % {\usebeamerfont{subtitle}\insertsubtitle} % 插入副标题

    % {\usebeamerfont{subtitle}\@courseLabel} % 插入课程标签
    
    % {\usebeamerfont{author}\usebeamercolor[fg]{author}\textbf{\insertauthor} \ifdefempty{\@IDnumber}{}{(\@IDnumber)}} % 插入加粗的作者名，如果有学号则括号显示
  
    {\usebeamerfont{author}\usebeamercolor[fg]{author}\textbf{\insertauthor}}

    {\usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate} % 插入日期
  \end{beamercolorbox} % 结束颜色盒
}



\setbeamercolor{framesubtitle}{fg=dred,bg=white}
\setbeamercolor{frametitle}{fg=dred,bg=white}
% --- 定义帧标题和副标题布局 ---
\setbeamertemplate{frametitle}{% % 设置帧标题模板
  \vspace*{-0.05\paperwidth} % 向上负向间距 3.5ex，用于微调位置，抵消默认留白
  \begin{beamercolorbox}[leftskip=0cm]{frametitle}% % 创建颜色盒，左侧跳过 2cm (为了给 Logo 让位)
    {\usebeamerfont{framesubtitle}\color{dred}\insertframesubtitle} \\% 使用帧副标题字体插入副标题，然后换行
    {\usebeamerfont{frametitle}\color{red}\insertframetitle} % 使用帧标题字体插入标题
  \end{beamercolorbox} % 结束颜色盒
}







% --- 定义结束页 (Backmatter) ---
\newcommand{\backmatter}[1][]{ % 定义命令：生成结束页，可选参数 #1
\begingroup % 开始局部组
  
  \begin{frame}[c] % 开始一个垂直居中的 frame
    \centering % 内容居中
    \begin{minipage}{\textwidth} % 开始全文宽的小页面
      \usebeamercolor[fg]{normal text} % 使用正常文本前景色
      \centering % 内部居中
      \ifstrequal{#1}{notitle}{}{ % 如果参数不是 'notitle'
        \Huge \inserttitle % 显示巨大号的标题
        \vspace{5mm} % 垂直间距 5mm
      }
      \Large \textsl{\\Thank you for listening! \\ Any questions?} % 显示斜体的感谢语和提问邀请
    \end{minipage} % 结束小页面
  \end{frame} % 结束 frame
\endgroup % 结束局部组
}




% --- 定义章节导航和目录 ---
\AtBeginSection[] % 在每个 \section 开始时自动执行
{
    
    \begingroup % 开始局部组
    \setbeamercolor{section in toc}{fg=dred}
    \begin{frame}{目录} % 创建标题为 "Table of Contents" 的帧
        \tableofcontents[currentsection] % 显示目录，高亮当前章节
    \end{frame} % 结束帧
    \endgroup % 结束局部组
}

% 设置目录中章节的显示样式
\setbeamertemplate{section in toc}{$\blacktriangleright$~\inserttocsection} % 章节前加黑色三角符号

% --- 自动化帧副标题 ---
\makeatletter % 允许使用 @
    \pretocmd\beamer@checkframetitle{\framesubtitle{\thesection \, \secname}} % 在检查帧标题前，自动将副标题设置为 "章节号 章节名"
\makeatother % 恢复 @

% --- 避免分页帧的编号重复 ---
\setbeamertemplate{frametitle continuation}{} % 清空帧标题续页标记 (例如不再显示 "Title (cont.)")，防止一页变多页时标题重复或编号混乱




\endinput % 结束包的处理